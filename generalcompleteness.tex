%%%%
%% generalcompleteness.tex
%%
%% Copyright 2011 Jeffrey Finkelstein
%%
%% Except where otherwise noted, this work is made available under the terms of
%% the Creative Commons Attribution-ShareAlike 3.0 license,
%% http://creativecommons.org/licenses/by-sa/3.0/.
%%
%% You are free:
%%    * to Share — to copy, distribute and transmit the work
%%    * to Remix — to adapt the work
%% Under the following conditions:
%%    * Attribution — You must attribute the work in the manner specified by
%%    the author or licensor (but not in any way that suggests that they
%%    endorse you or your use of the work).
%%    * Share Alike — If you alter, transform, or build upon this work, you may
%%    distribute the resulting work only under the same, similar or a 
%%    compatible license.
%%    * For any reuse or distribution, you must make clear to others the 
%%    license terms of this work. The best way to do this is with a link to the
%%    web page http://creativecommons.org/licenses/by-sa/3.0/.
%%    * Any of the above conditions can be waived if you get permission from
%%    the copyright holder.
%%    * Nothing in this license impairs or restricts the author's moral rights.
%%%%
\section{Completeness in \texorpdfstring{\AP}{AP}}

In this section we use the techniques of \cite[Theorem~8.7]{bcffm} to present a general theorem which provides a complete problem for a number of interesting complexity classes.
We first need some definitions.

If $\mathcal{C}$ is a complexity class (that is, a set of languages), then it is \defn{closed under complement} if $L\in\mathcal{C}$ implies $\overline{L}\in\mathcal{C}$.
This implies that $\coC=\mathcal{C}$.

If $\mathcal{C}$ is a complexity class then the class $\forall\mathcal{C}$ is the set of languages $A$ such that there exists a language $B\in\mathcal{C}$ and a polynomial $p$ satisfying $x\in A$ if and only if $\forall w\in\Sigma^{\leq p(|x|)} \pair{x}{w}\in B$.
$\forall\mathcal{C}$ is called the \defn{closure of $\mathcal{C}$ under polynomially bounded universal quantification}.
If $\forall\mathcal{C}=\mathcal{C}$ then we say $\mathcal{C}$ is \defn{closed under polynomially bounded universal quantification}.
Recall that for each $k\in\mathbb{N}$, $\PKP$ is closed under polynomially bounded universal quantification.

\begin{theorem}\label{thm:generalcompleteness}
  Suppose $\mathcal{C}$ is a subset of $\AP$ which meets the following conditions:
  \begin{enumerate}
  \item $\mathcal{C}$ is closed under complement
  \item $\mathcal{C}$ is closed under polynomially bounded universal quantification
  \item the problem of deciding whether two strings are equal is in $\mathcal{C}$
  \end{enumerate}
  Then $\CEq$ has a complete problem under $\kr$ reductions.
\end{theorem}
\begin{proof}
  First we will define a helper algorithm which decides whether a given machine accepts an equivalence relation on strings up to a given length.
  Define the algorithm $A$ as follows on input $\pair{M}{n}$, where $M$ is a polynomially clocked Turing machine of type $\mathcal{C}$ and $n\in\mathbb{N}$:
  \begin{enumerate}
  \item universally guess $a,b,$ and $c\in\Sigma^{\leq n}$
  \item simulate $M$ on $\pair{a}{a}$; if it rejects, reject
  \item simulate $M$ on $\pair{a}{b}$, then on $\pair{b}{a}$; if the former accepts and the latter rejects, reject
  \item simulate $M$ on $\pair{a}{b}$, then on $\pair{b}{c}$, then on $\pair{a}{c}$; if the first two accept and the last one rejects, reject
  \item if execution reaches this point, accept
  \end{enumerate}
  These simulations check that $L(M)$ satisfies reflexivity, symmetry, and transitivity on strings of length at most $n$.
  If $A$ accepts, then the three properties are satisfied, and if it rejects then one of the three properties is violated.
  Since $M$ is a machine of type $\mathcal{C}$ and $\mathcal{C}$ is closed under both complement and polynomially bounded universal quantification, the universal guesses $a,b,$ and $c$ (of length at most $n$) and checking whether the six simulations of $M$ accept or reject do not increase the complexity of this algorithm beyond the class $\mathcal{C}$.
  If $p$ is the polynomial which bounds the running time of $M$, then the running time of this algorithm is $6p(|\pair{1^n}{1^n}|)+c$, where $c$ is a constant which represents the time needed to account for the implementation of $A$ (the control of the simulations of $M$, performing logical conjunctions, etc.).
  Hence the running time of $A$ is polynomial in $n$.

  Now we can define the set $R$ by
  \begin{align*}
    R = {} & \{\pair{u}{v}|u=v\} \\
    & \cup \{\pair{\triple{M}{x}{1^{t_x}}}{\triple{M}{y}{1^{t_y}}} |
    \text{1 through 4 below are satisfied}\}
  \end{align*}
  where the conditions are
  \begin{enumerate}
  \item\label{itm:machine} $M$ is a polynomially clocked Turing machine of type $\mathcal{C}$
  \item\label{itm:emx} $A$ accepts $\pair{M}{|x|}$ within $t_x$ steps
  \item\label{itm:emy} $A$ accepts $\pair{M}{|y|}$ within $t_y$ steps
  \item\label{itm:accepts} $M$ accepts $\pair{x}{y}$
  \end{enumerate}
  We claim that $R$ is $\CEq$-complete.

  First we show that $R\in\mathcal{C}$.
  By the argument above, $A$ is a $\mathcal{C}$ algorithm.
  Since $M$ is a polynomially clocked $\mathcal{C}$ machine by \autoref{itm:machine}, then the simulation of $M$ on $\pair{x}{y}$ in \autoref{itm:accepts} can be performed by a $\mathcal{C}$ algorithm.
  Assuming without loss of generality that $|x|\geq |y|$, if $A$ accepts $\pair{M}{|x|}$ within $t_x$ steps then we know that there is a polynomial time bound on the running time of $M$.
  Finally, testing for equality is in $\mathcal{C}$ by hypothesis so deciding $R$ overall can be performed by a $\mathcal{C}$ algorithm.

  Next we show that $R$ is an equivalence relation.
  Reflexivity follows from the reflexivity of the equality relation.
  For symmetry, suppose $\pair{\triple{M}{x}{1^{t_x}}}{\triple{M}{y}{1^{t_y}}}\in R$.
  Since \autoref{itm:emx} and \autoref{itm:emy} are true by hypothesis, we know that symmetry on strings of length at most $\max(|x|, |y|)$ in $L(M)$ is satisfied, and that includes the strings $x$ and $y$.
  So since $M$ accepts $\pair{x}{y}$ it must follow that $M$ accepts $\pair{y}{x}$.
  Furthermore, \autoref{itm:machine}, \autoref{itm:emx}, and \autoref{itm:emy} are the same up to symmetry of $x$ and $y$, so we have $\pair{\triple{M}{y}{1^{t_y}}}{\triple{M}{x}{1^{t_x}}}\in R$.
  For transitivity, suppose that both $\pair{\triple{M}{x}{1^{t_x}}}{\triple{M}{y}{1^{t_y}}}\in R$ and $\pair{\triple{M}{y}{1^{t_y}}}{\triple{M}{z}{1^{t_z}}}\in R$.
  Since transitivity is true on strings of length at most $\max(|x|, |y|, |z|)$ by the transitivity propositions checked by \autoref{itm:emx} and \autoref{itm:emy}, and since $M$ accepts both $\pair{x}{y}$ and $\pair{y}{z}$ by hypothesis, it must follow that $M$ accepts $\pair{x}{z}$.
  Again the conditions in \autoref{itm:machine}, \autoref{itm:emx}, and \autoref{itm:emy} are the same.
  We have shown that $R$ is reflexive, symmetric, and transitive, so it is an equivalence relation.
  At this point, we have proven that $R\in\CEq$.

  Now we need to show that $R$ is $\CEq$-hard.
  Let $S\in\CEq$.
  Suppose $M$ is the polynomially clocked $\mathcal{C}$ machine which decides $S$, and $p$ is the polynomial which bounds the running time of $M$.
  Then the kernel reduction from $S$ to $R$ is $w\mapsto\triple{M}{w}{1^{6p(|\pair{w}{w}|)+c}}$, where $p$ and $c$ are the polynomial and constant described in the first paragraph of this proof.
  Call this reduction $f$.
  The reduction is obviously computable in time polynomial in $|w|$.
  It remains to show that this reduction is correct.

  Suppose $\pair{x}{y}\in S$.
  Now $f(x)=\triple{M}{x}{1^{6p(|\pair{x}{x}|)+c}}$ and $f(y)=\triple{M}{y}{1^{6p(|\pair{y}{y}|)+c}}$.
  \autoref{itm:machine} is true by construction, and \autoref{itm:accepts} is true since $M$ is the machine which decides $S$.
  Assume \autoref{itm:emx} is false.
  Then $M$ does not accept an equivalence relation on strings of length at most $|x|$.
  This is a contradiction, since $M$ decides $S$, an equivalence relation, by hypothesis.
  Therefore \autoref{itm:emx} must be satisfied.
  The same argument applies to \autoref{itm:emy}.
  Hence $\pair{f(x)}{f(y)}\in R$.

  If $\pair{x}{y}\notin S$ then $M$ does not accept $\pair{x}{y}$, since otherwise $\pair{x}{y}$ would be a member of $S$.
  Hence $\pair{x}{y}\notin R$.  
  Therefore we have shown that $R$ is $\CEq$-hard and $R\in\CEq$, so $R$ is $\CEq$-complete.
\end{proof}

\begin{corollary}\label{cor:completeproblem}
  The following complexity classes have a complete problem under polynomial time kernel reductions:
  \begin{enumerate}
  \item \SKPEq, for all $k\geq 1$
  \item \PSPACEEq
  \end{enumerate}
\end{corollary}

\begin{remark}
  That $\NPcoNPEq$ has a complete problem is remarkable because there is an oracle relative to which $\NPcoNP$ has a complete problem (and additionally $\P\neq\NPcoNP\neq\NP$) \cite{hi} and an oracle relative to which it does not have a complete problem \cite{sipser}.
  This is perhaps evidence that some languages are inherently \emph{not} expressible by an equivalence relation.
\end{remark}

\begin{openproblem}
  Is there a more general characterization of complexity classes which have a complete problem?
  Can we adapt this idea to produce a complete problem for $\PEq$ (which is not closed under polynomially bounded universal quantification) or $\NPEq$ (which is closed under neither complement nor polynomially bounded universal quantification)?
\end{openproblem}

\begin{openproblem}
  Can this theorem be used to construct complete problems for smaller complexity classes like $\NL$ under the appropriate time-bounded reduction?
  Larger classes such as $\EXP$?
\end{openproblem}

\begin{openproblem}
  To what other equivalence relations does this complete problem reduce?
  Are there ``natural'' complete problems in complexity classes which satisfy the conditions in \autoref{thm:generalcompleteness}?
\end{openproblem}
