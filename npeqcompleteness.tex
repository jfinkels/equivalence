%%%%
%% npeqcompleteness.tex
%%
%% Copyright 2011, 2012 Jeffrey Finkelstein
%%
%% Except where otherwise noted, this work is made available under the terms of
%% the Creative Commons Attribution-ShareAlike 3.0 license,
%% http://creativecommons.org/licenses/by-sa/3.0/.
%%
%% You are free:
%%    * to Share — to copy, distribute and transmit the work
%%    * to Remix — to adapt the work
%% Under the following conditions:
%%    * Attribution — You must attribute the work in the manner specified by
%%    the author or licensor (but not in any way that suggests that they
%%    endorse you or your use of the work).
%%    * Share Alike — If you alter, transform, or build upon this work, you may
%%    distribute the resulting work only under the same, similar or a 
%%    compatible license.
%%    * For any reuse or distribution, you must make clear to others the 
%%    license terms of this work. The best way to do this is with a link to the
%%    web page http://creativecommons.org/licenses/by-sa/3.0/.
%%    * Any of the above conditions can be waived if you get permission from
%%    the copyright holder.
%%    * Nothing in this license impairs or restricts the author's moral rights.
%%%%
\section{Completeness in \texorpdfstring{\NPEq}{NPEq} and \texorpdfstring{\NP}{NP}}
\label{sec:npeqcompleteness}

In this section we examine the relationship between \NP-complete problems and \NPEq-complete problems.
Before proceeding, we will need some definitions concerning graphs.

If $G$ is a graph, then $V(G)$ is the set of vertices in $G$ and $E(G)$ is the set of edges in $G$.
If $G$ and $H$ are two graphs, then $G$ \defn{is isomorphic to} $H$ if $\exists\phi\colon V(G)\to V(H)$, a bijection, such that $\forall u,v\in V(G)$, $[(u,v)\in E(G)\iff (\phi(u), \phi(v))\in E(H)]$.
We denote this by $G\cong H$.
The much-studied graph isomorphism problem (\GI), the problem of deciding whether two given graphs are isomorphic, is one of few problems in $\NP$ not known to be either in $\P$ or \NP-complete.

Let $\Pi$ be an arbitrary graph property (which holds for all isomorphic graphs if it holds for any one of them).
Call $\Pi$ the \defn{null property} if it is false for all graphs.
We say that $\Pi$ is a \defn{uniform property} if for all $n\in\mathbb{N}$ there exists a graph $G$ with $n$ vertices such that $\Pi(G)$ is true.
Let $L_\Pi$ be the language on graphs $G$ defined by $\lb G\st\Pi(G)\textnormal{ is true}\rb$.
Say that $\Pi$ is an \defn{\NP-complete property} if $L_\Pi$ is \NP-complete.
It is easy to see that if $\Pi$ is either a uniform property or an \NP-complete property, then it is not a null property.

We first show that there are problems in $\NPEq$ which are also \NP-complete (though they may not necessarily be \NPEq-complete).
Define $A(\Pi)$ by
\begin{displaymath}
  A(\Pi) = \lb \pair{G}{H}\st G\cong H \plain{or} (\Pi(G) \plain{and} \Pi(H))\rb.
\end{displaymath}
By checking the three required properties of an equivalence relation, we find the following.
(The proof of this proposition is straightforward and is left as an exercise for the reader.)
\begin{proposition}
  For all graph properties $\Pi$, $A(\Pi)$ is an equivalence relation.
\end{proposition}
We use this fact to show that there are \NP-complete equivalence relations.
\begin{proposition}\label{prop:APi}
  If $\Pi$ is an \NP-complete property, then $A(\Pi)$ is an \NP-complete equivalence relation.
\end{proposition}
\begin{proof}
  The previous proposition shows that $A(\Pi)$ is an equivalence relation, so it remains to show that it is \NP-complete.
  Let $H$ be a graph for which $\Pi(H)$ is true, which exists because $\Pi$ is not a null property.
  The reduction is from $L_\Pi$, and the mapping is given by $G\mapsto\pair{G}{H}$.
  This function is computable in polynomial time (the size of the graph $H$ is constant with respect to the size of the graph $G$).

  Suppose $G\in L_\Pi$, then $\Pi(G)$ and $\Pi(H)$ are both true, so $\pair{G}{H}\in A(\Pi)$.
  Suppose now that $G\notin L_\Pi$, so it certainly must not be the case that $\Pi(G)$ and $\Pi(H)$ are both true.
  However, neither can $G\cong H$ be true, since otherwise $\Pi(G)$ would be true (since the graph property $\Pi$ is true on all graphs which are isomorphic).
  Thus $\pair{G}{H}\notin A(\Pi)$.
  We conclude that $L_\Pi\mor A(\Pi)$, and so it is an \NP-complete equivalence relation.
\end{proof}

We know that \NP-complete graph properties exist (Hamoltinicity, partitionability into triangles, etc.), so it follows that there exist equivalence relations which are \NP-complete.
Using this fact we can show that completeness in $\NPEq$ under $\kr$ reductions implies completeness in $\NP$ under $\mor$ reductions.

\begin{corollary}
  If an equivalence relation $R$ is \NPEq-complete then it is also \NP-complete.
\end{corollary}
\begin{proof}
  Let $A$ be an \NP-complete equivalence relation in \NPEq, which exists by the previous theorem.
  Since $R$ is \NPEq-complete, there exists a polynomial time kernel reduction, call it $f$, from $A$ to $R$.
  The polynomial time many-one reduction from $A$ to $R$ induced by $f$, namely $\pair{x}{y}\mapsto\pair{f(x)}{f(y)}$, proves that $R$ is \NP-hard.
  Since $R$ is in $\NP$ by hypothesis, it is therefore \NP-complete.
\end{proof}

This corollary provides not only a proof that $\PEq=\NPEq$ implies $\P=\NP$, but also a clearer proof of \cite[Proposition~8.1]{bcffm}.

\begin{corollary}
  $\PEq=\NPEq$ if and only if $\P=\NP$.
\end{corollary}
\begin{proof}
  For the forward direction, if $\PEq=\NPEq$, then some \NP-complete equivalence relation is in $\P$.
  Since polynomial time many-one reductions compose, this implies a polynomial time algorithm for any problem in $\NP$, so $\P=\NP$.

  The reverse direction is obvious.
\end{proof}

\begin{proposition}[\cite{bcffm}, Proposition~8.1]
  If $\GI$ is \NPEq-complete then the polynomial time hierarchy collapses to the second level ($\PH=\STP$).
\end{proposition}
\begin{proof}
  If $\GI$ is \NPEq-complete then it is \NP-complete by the previous corollary.
  This implies the stated collapse (see \cite{schoning87}).
\end{proof}

We currently do not know whether $\NPEq$ has a complete problem under polynomial time kernel reductions.
\begin{openproblem}
  Can we prove that $\NPEq$ has a complete problem unconditionally?
\end{openproblem}

We will for now consider the consequences of the assumption that there exists an \NPEq-complete problem.

Define $A^=(\Pi)$ by
\begin{displaymath}
  A^=(\Pi) = \lb \pair{G}{H} \st \pair{G}{H}\in A(\Pi) \plain{and} |V(G)|=|V(H)|\rb
\end{displaymath}
for all graph properties $\Pi$.

\begin{proposition}\label{prop:APieq}
  If $\Pi$ is a uniform \NP-complete property, then $A^=(\Pi)$ is an \NP-complete equivalence relation.
\end{proposition}
\begin{proof}
  The proof is the same as the proof of \autoref{prop:APi}, but the reduction enforces that the graph $H$ is a graph with $|V(G)|$ vertices for which $\Pi(H)$ is true, which exists because $\Pi$ is a uniform property by hypothesis.
\end{proof}

Note that the number of equivalence classes of $A^=(\Pi)$ is infinite, since there are an infinite number of undirected graphs.
However, each of those equivalence classes is itself finite.
As justification, consider the equivalence class of an arbitrary graph $G$ in $A^=(\Pi)$, $[G]$.
$[G]$ includes exactly all the graphs $H$ which are isomorphic to $G$ plus all graphs $J$ for which $\Pi(J)$ is true and $|V(G)|=|V(J)|$ (if $\Pi(G)$ is true).
In either case, the graphs $H$ and $J$ have the same number of vertices as $G$.
The number of graphs on $|V(G)|$ vertices is finite, so $[G]$ is finite.

As a contrast, consider the equivalence relation
\begin{displaymath}
  R=\lb\pair{x}{y} \st x\plain{and}y\plain{have the same number of}1\textnormal{s}\rb.
\end{displaymath}
$R$ has an infinite number of equivalence classes: $[1]$, $[11]$, $[111]$, etc.
Each equivalence class is itself infinite as well: if $w\in\Sigma^*$ then $[w]$ contains $w$, $0w$, $00w$, etc.

These observations lead us to the following theorem.
Note that in the following theorem, if an equivalence relation $B$ is ``complete under $\kri$ reductions in $\NPEq$'' we mean that every equivalence relation in $\NPEq$ reduces to $B$ by a polynomial time computable kernel reduction which is also injective (that is, ``one-to-one'').

\begin{theorem}
  % If \Pi is additionally an \NP-complete property, then A^=(\Pi) would be an NP-complete equivalence relation.
  Let $\Pi$ be a uniform graph property.
  If $A^=(\Pi)$ is complete in $\NPEq$ under $\kr$ reductions, then it is not complete under $\kri$ reductions.
\end{theorem}
\begin{proof}
  For the sake of brevity, in this proof we will refer to $A^=(\Pi)$ by the shorter $A$.

  $R$ is obviously in $\PEq$, so it is in $\NPEq$.
  Since $A$ is \NPEq-complete, $R\kr A$.
  Thus there exists a polynomial time computable function $f$ such that $\pair{x}{y}\in R$ if and only if $\pair{f(x)}{f(y)}\in A$.

  Let $w\in\sigmastar$.
  Then $f(w)=G$ for some graph $G$.
  By the arguments in the text preceding this theorem, $[w]_R$ is infinite and $[f(w)]_A$ is finite.
  By \autoref{lem:image}, $f([w]_R)\subseteq [f(w)]_A$.
  Consider $f|_{[w]_R}$, that is, $f$ restricted to the domain $[w]_R$.
  Then $f|_{[w]_R}$ is a mapping from the infinite set $[w]_R$ to the finite set $[f(w)]_A$.
  By the pigeonhole principle, $f|_{[w]_R}$ is not injective.
  Hence the unrestricted reduction $f$ is not injective, and therefore $A$ is not $\kri$-complete in \NPEq.
\end{proof}
