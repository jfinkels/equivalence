%%%%
%% npeqcompleteness.tex
%%
%% Copyright 2011, 2012 Jeffrey Finkelstein
%%
%% Except where otherwise noted, this work is made available under the terms of
%% the Creative Commons Attribution-ShareAlike 3.0 license,
%% http://creativecommons.org/licenses/by-sa/3.0/.
%%
%% You are free:
%%    * to Share — to copy, distribute and transmit the work
%%    * to Remix — to adapt the work
%% Under the following conditions:
%%    * Attribution — You must attribute the work in the manner specified by
%%    the author or licensor (but not in any way that suggests that they
%%    endorse you or your use of the work).
%%    * Share Alike — If you alter, transform, or build upon this work, you may
%%    distribute the resulting work only under the same, similar or a 
%%    compatible license.
%%    * For any reuse or distribution, you must make clear to others the 
%%    license terms of this work. The best way to do this is with a link to the
%%    web page http://creativecommons.org/licenses/by-sa/3.0/.
%%    * Any of the above conditions can be waived if you get permission from
%%    the copyright holder.
%%    * Nothing in this license impairs or restricts the author's moral rights.
%%%%
\section{Many-one and kernel completeness}
\label{sec:npeqcompleteness}

In this section we examine the relationship between $\mathcal{C}$-complete problems and \CEq-complete problems.
%% Before proceeding, we will need some definitions concerning graphs.
%%
%% If $G$ is a graph, then $V(G)$ is the set of vertices in $G$ and $E(G)$ is the set of edges in $G$.
%% If $G$ and $H$ are two graphs, then $G$ \defn{is isomorphic to} $H$ if $\exists\phi\colon V(G)\to V(H)$, a bijection, such that $\forall u,v\in V(G)$, $[(u,v)\in E(G)\iff (\phi(u), \phi(v))\in E(H)]$.
%% We denote this by $G\cong H$.
%% The much-studied graph isomorphism problem (\GI), the problem of deciding whether two given graphs are isomorphic, is one of few problems in $\NP$ not known to be either in $\P$ or \NP-complete.
%%
%% Let $\Pi$ be an arbitrary graph property (which holds for all isomorphic graphs if it holds for any one of them).
%% Call $\Pi$ the \defn{null property} if it is false for all graphs.
%% We say that $\Pi$ is a \defn{uniform property} if for all $n\in\mathbb{N}$ there exists a graph $G$ with $n$ vertices such that $\Pi(G)$ is true.
%% Let $L_\Pi$ be the language on graphs $G$ defined by $\lb G\st\Pi(G)\textnormal{ is true}\rb$.
%% Say that $\Pi$ is a \defn{$\mathcal{C}$-complete property} if $L_\Pi$ is $\mathcal{C}$-complete under $\mor$ reductions in some complexity class $\mathcal{C}$.
%% It is easy to see that if $\Pi$ is either a uniform property or a $\mathcal{C}$-complete property, then it is not a null property.

Suppose (for the rest of this section) that $\mathcal{K}$ is some set of structures in which
\begin{enumerate}
\item each structure $X$ has a size, denoted $|X|$, and
\item pairs $(X, Y)$ have some notion of equivalence, denoted $X\cong Y$, in which $X\cong Y$ implies $|X|=|Y|$.
\end{enumerate}
Let $\IsoK=\lb\pair{X}{Y}\st X\cong Y\rb$.
\begin{example}
  Consider the set of structures $\mathcal{G}$, the set of all finite undirected graphs.
  All isomorphic graphs have the same number of vertices.
  In this case, $\IsoG=\GI$, the well-studied graph isomorphism problem.
\end{example}

Let $\Pi$ be some property (that is, a boolean proposition) for which $X\cong Y$ implies $\Pi(X)=\Pi(Y)$ (that is, they are either both true or both false).
Call $\Pi$ the \defn{null property} if it is false for all structures.
We say that $\Pi$ is a \defn{uniform property} if for all $n\in\mathbb{N}$ there exists a structure $X$ with $|X|=n$ such that $\Pi(X)$ is true.
Let $L_\Pi$ be the language of structures $X$ defined by $\lb X\st\Pi(X)\textnormal{ is true}\rb$.
Say that $\Pi$ is a \defn{$\mathcal{C}$-complete property} if $L_\Pi$ is $\mathcal{C}$-complete under $\mor$ reductions in some complexity class $\mathcal{C}$.
It is easy to see that if $\Pi$ is either a uniform property or a $\mathcal{C}$-complete property, then it is not a null property.
\begin{example}
  Hamiltonicity is a uniform property on the set of finite undirected graphs (the circle graph on $n$ vertices has a Hamiltonian cycle for all $n\in\mathbb{N}$).
  It is also an \NP-complete property, since in this case, $L_\Pi=\mathsf{HAMPATH}$.
\end{example}

We first show that there are problems in $\CEq$ which are also $\mathcal{C}$-complete (though they may not necessarily be \CEq-complete).
Define $A(\Pi)$ by
\begin{displaymath}
  A(\Pi) = \lb \pair{X}{Y}\st \pair{X}{Y}\in\IsoK \plain{or} (\Pi(X) \plain{and} \Pi(Y) \text{ are both true})\rb.
\end{displaymath}
By checking the three required properties of an equivalence relation, we find the following.
(The proof of this proposition is straightforward and is left as an exercise for the reader.)
\begin{proposition}
  For all properties $\Pi$ on elements of $\mathcal{K}$, $A(\Pi)$ is an equivalence relation on $\mathcal{K}$.
\end{proposition}
We use this fact to show that there are $\mathcal{C}$-complete equivalence relations.
\begin{proposition}\label{prop:APi}
  Let $\mathcal{C}$ be a complexity class such that $\IsoK\in\mathcal{C}$.
  If $\Pi$ is a $\mathcal{C}$-complete property, then $A(\Pi)$ is a $\mathcal{C}$-complete equivalence relation.
\end{proposition}
\begin{proof}
  The previous proposition shows that $A(\Pi)$ is an equivalence relation, so it remains to show that it is $\mathcal{C}$-complete.
  %% TODO Why is this statement true? We need to require that C is closed under
  %% conjunction.
  $A(\Pi)$ is in $\mathcal{C}$ because $X\cong Y$, $\Pi(X)$, and $\Pi(Y)$ can all be checked by a $\mathcal{C}$ algorithm.

  Let $Y$ be a graph for which $\Pi(Y)$ is true, which exists because $\Pi$ is not a null property.
  The reduction is from $L_\Pi$, and the mapping is given by $X\mapsto\pair{X}{Y}$.
  This function is computable in polynomial time (the size of the structure $Y$ is constant with respect to the size of the structure $Y$).

  Suppose $X\in L_\Pi$, then $\Pi(X)$ and $\Pi(Y)$ are both true, so $\pair{X}{Y}\in A(\Pi)$.
  Suppose now that $X\notin L_\Pi$, so it certainly must not be the case that $\Pi(X)$ and $\Pi(Y)$ are both true.
  However, neither can $X\cong Y$ be true, since otherwise $\Pi(X)$ would be true (since the property $\Pi$ is true on all structures which are isomorphic).
  Thus $\pair{X}{Y}\notin A(\Pi)$.
  We conclude that $L_\Pi\mor A(\Pi)$, and so it is a $\mathcal{C}$-complete equivalence relation.
\end{proof}

We know that $\NP$ contains \GI, and that \NP-complete graph properties exist (Hamoltinicity, 3-colorability, etc.), so it follows that there exist equivalence relations which are \NP-complete.

\begin{corollary}
  If $\Pi$ is an \NP-complete property, then $A(\Pi)$ is an \NP-complete equivalence relation.
\end{corollary}

We can now show that completeness in $\CEq$ under $\kr$ reductions implies completeness in $\mathcal{C}$ under $\mor$ reductions.

\begin{corollary}\label{cor:ceqimpliesc}
  Let $\mathcal{C}$ be a complexity class such that $\IsoK\in\mathcal{C}$.
  If there exists a $\mathcal{C}$-complete property and an equivalence relation $R$ is \CEq-complete then $R$ is also $\mathcal{C}$-complete.
\end{corollary}
\begin{proof}
  Let $\Pi$ be the $\mathcal{C}$-complete property.
  Let $A$ be a $\mathcal{C}$-complete equivalence relation in $\mathcal{C}$, which exists by \autoref{prop:APi}.
  Since $R$ is \CEq-complete, there exists a polynomial time kernel reduction, call it $f$, from $A$ to $R$.
  The polynomial time many-one reduction from $A$ to $R$ induced by $f$, namely $\pair{x}{y}\mapsto\pair{f(x)}{f(y)}$, proves that $R$ is $\mathcal{C}$-hard.
  Since $R$ is in $\mathcal{C}$ by hypothesis, it is therefore $\mathcal{C}$-complete.
\end{proof}

Specifically, if $R$ is \NPEq-complete then it is \NP-complete.
This corollary provides not only a proof that $\PEq=\NPEq$ implies $\P=\NP$, but also a clearer proof of \cite[Proposition~8.1]{bcffm}.

\begin{corollary}
  $\PEq=\NPEq$ if and only if $\P=\NP$.
\end{corollary}
\begin{proof}
  For the forward direction, if $\PEq=\NPEq$, then some \NP-complete equivalence relation is in $\P$.
  Since polynomial time many-one reductions compose, this implies a polynomial time algorithm for any problem in $\NP$, so $\P=\NP$.

  The reverse direction is obvious.
\end{proof}

\begin{proposition}[\cite{bcffm}, Proposition~8.1]
  If $\GI$ is \NPEq-complete then the polynomial time hierarchy collapses to the second level ($\PH=\STP$).
\end{proposition}
\begin{proof}
  If $\GI$ is \NPEq-complete then it is \NP-complete by \autoref{cor:ceqimpliesc}.
  This implies the stated collapse (see \cite{schoning87}).
\end{proof}

Note that we currently do not know whether $\NPEq$ (or $\SKPEq$ for any $k$) has a complete problem under polynomial time kernel reductions.
\begin{openproblem}
  Can we prove that $\NPEq$ (or $\SKPEq$ for any $k$) has a complete problem unconditionally?
\end{openproblem}

We will for now consider the consequences of the assumption that there exists a \CEq-complete problem.

Define $A^=(\Pi)$ by
\begin{displaymath}
  A^=(\Pi) = \lb \pair{X}{Y} \st \pair{X}{Y}\in A(\Pi) \plain{and} |X|=|Y|\rb
\end{displaymath}
for all properties $\Pi$.
(Note that the requirement that $|X|=|Y|$ only affects the ``$\Pi(X)$ and $\Pi(Y)$ are both true'' part of the definition of $A(\Pi)$, since $X\cong Y$ implies $|X|=|Y|$ by our initial assumptions.)

\begin{proposition}\label{prop:APieq}
  Let $\mathcal{C}$ be a complexity class such that $\IsoK\in\mathcal{C}$.
  If $\Pi$ is a uniform $\mathcal{C}$-complete property, then $A^=(\Pi)$ is a $\mathcal{C}$-complete equivalence relation.
\end{proposition}
\begin{proof}
  % TODO Is it possible to do this for arbitrary structures without stating
  % explicitly how to force the output length?
  The proof is the same as the proof of \autoref{prop:APi}, but the reduction enforces that the structure $Y$ is a structure with $|Y|=|X|$ for which $\Pi(Y)$ is true, which exists because $\Pi$ is a uniform property by hypothesis.
\end{proof}

Note that the number of equivalence classes of $A^=(\Pi)$ is infinite, since there will be at least one equivalence class for each length.
However, each of those equivalence classes is itself finite.
As justification, consider the equivalence class of an arbitrary structure $X$ in $A^=(\Pi)$, $[X]$.
$[X]$ includes exactly all the structures $Y$ which are isomorphic to $X$ plus (at most) all structures $Z$ for which $\Pi(Z)$ is true and $|X|=|Z|$ (if $\Pi(X)$ is true at all).
In either case, the structures $Y$ and $Z$ have the same size as $X$ (since our notion of isomorphism implies that $Y$ and $Z$ have equal sizes).
The number of structures of size $|X|$ is finite, so $[X]$ is finite.

As a contrast, consider the equivalence relation
\begin{displaymath}
  R=\lb\pair{x}{y} \st x\plain{and}y\plain{have the same number of}1\textnormal{s}\rb.
\end{displaymath}
$R$ has an infinite number of equivalence classes: $[1]$, $[11]$, $[111]$, etc.
Each equivalence class is itself infinite as well: if $w\in\Sigma^*$ then $[w]$ contains $w$, $0w$, $00w$, etc.

These observations lead us to the following theorem.
Note that in the following theorem, if an equivalence relation $B$ is ``complete under $\kri$ reductions in $\CEq$'' we mean that every equivalence relation in $\CEq$ reduces to $B$ by a polynomial time computable kernel reduction which is also injective (that is, ``one-to-one'').

\begin{theorem}
  % If \Pi is additionally an $\mathcal{C}$-complete property, then A^=(\Pi) would be an $\mathcal{C}$-complete equivalence relation.
  Suppose
  \begin{itemize}
  \item $R$ is defined as in the preceding discussion,
  \item $\mathcal{C}$ is a complexity class such that $\IsoK\in\mathcal{C}$ and $R\in\mathcal{C}$, and
  \item $\Pi$ is a uniform property.
  \end{itemize}
  If $A^=(\Pi)$ is complete in $\CEq$ under $\kr$ reductions, then it is not complete under $\kri$ reductions.
\end{theorem}
\begin{proof}
  For the sake of brevity, in this proof we will refer to $A^=(\Pi)$ by the shorter $A$.

  Since $A$ is \CEq-complete, $R\kr A$.
  Thus there exists a polynomial time computable function $f$ such that $\pair{x}{y}\in R$ if and only if $\pair{f(x)}{f(y)}\in A$.

  Let $w\in\sigmastar$.
  Then $f(w)=X$ for some structure $X\in\mathcal{K}$.
  By the arguments in the discussion preceding this theorem, $[w]_R$ is infinite and $[f(w)]_A$ is finite.
  By \autoref{lem:image}, $f([w]_R)\subseteq [f(w)]_A$.
  Consider $f|_{[w]_R}$, that is, $f$ restricted to the domain $[w]_R$.
  Then $f|_{[w]_R}$ is a mapping from the infinite set $[w]_R$ to the finite set $[f(w)]_A$.
  By the pigeonhole principle, $f|_{[w]_R}$ is not injective.
  Hence the unrestricted reduction $f$ is not injective, and therefore $A$ is not $\kri$-complete in \CEq.
\end{proof}

\begin{corollary}
  % If \Pi is additionally an \NP-complete property, then $A^=(\Pi)$ would be an \NP-complete equivalence relation.
  Let $\Pi$ be a uniform graph property.
  If $A^=(\Pi)$ is complete in $\NPEq$ under $\kr$ reductions, then it is not complete under $\kri$ reductions.
\end{corollary}
\begin{proof}
  $\NP$ satisfies the conditions on $\mathcal{C}$ in the hypothesis of the previous theorem if we choose $\mathcal{K}$ to be the set of graphs so that $\IsoK$ is $\GI$ (that is, $\GI\in\NP$ and $R\in\NP$).
\end{proof}

This result is interesting because it again demonstrates that the number and size of equivalence classes is important when considering the (im)possibility of polynomial time kernel reductions between equivalence relations.
